<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Contributions</title>
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      orderBy, 
      onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDN7zu2pc-DRSTzEZLYq4BCXDKItiwbDi8",
      authDomain: "family-contributions.firebaseapp.com",
      projectId: "family-contributions",
      storageBucket: "family-contributions.firebasestorage.app",
      messagingSenderId: "322744991780",
      appId: "1:322744991780:web:eb4843cf64ef3245a218b1"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");
    const contributionForm = document.getElementById("contributionForm");
    const contributionsList = document.getElementById("contributionsList");
    const searchInput = document.getElementById("searchInput");

    let allContributions = []; // store all contributions locally

    // Google Login
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Auth State
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userInfo.textContent = `Hello, ${user.displayName}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        contributionForm.style.display = "block";
        searchInput.style.display = "block";
        loadContributions();
      } else {
        userInfo.textContent = "Not signed in";
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        contributionForm.style.display = "none";
        searchInput.style.display = "none";
        contributionsList.innerHTML = "";
      }
    });

    // Add contribution
    contributionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const amount = e.target.amount.value;
      if (!amount) return alert("Enter amount!");
      await addDoc(collection(db, "contributions"), {
        user: auth.currentUser.displayName,
        amount,
        timestamp: new Date()
      });
      e.target.reset();
    });

    // Load contributions (real-time)
    function loadContributions() {
      const q = query(collection(db, "contributions"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        allContributions = []; // reset
        snapshot.forEach((doc) => {
          allContributions.push(doc.data());
        });
        renderContributions(allContributions);
      });
    }

    // Render contributions
    function renderContributions(contributions) {
      contributionsList.innerHTML = "";
      contributions.forEach((data) => {
        const li = document.createElement("li");
        li.textContent = `${data.user} contributed ${data.amount}`;
        contributionsList.appendChild(li);
      });
    }

    // Search filter
    searchInput.addEventListener("input", () => {
      const term = searchInput.value.toLowerCase();
      const filtered = allContributions.filter(c => 
        c.user.toLowerCase().includes(term)
      );
      renderContributions(filtered);
    });
  </script>
</head>
<body>
  <h1>ðŸ’° Family Contributions</h1>
  <p id="userInfo">Not signed in</p>
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <form id="contributionForm" style="display:none;">
    <input type="number" name="amount" placeholder="Enter contribution amount" required />
    <button type="submit">Contribute</button>
  </form>

  <input id="searchInput" type="text" placeholder="Search by name..." style="display:none; margin-top:10px;" />

  <h2>ðŸ“Œ Contributions</h2>
  <ul id="contributionsList"></ul>
</body>
</html>
