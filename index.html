<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Contributions</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    h1 { text-align: center; }
    .card { background: white; padding: 20px; margin: 20px auto; max-width: 400px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button { width: 100%; padding: 10px; margin-top: 10px; }
    .hidden { display: none; }
    .contribution { padding: 5px; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>

  <h1>💰 Family Contributions</h1>

  <!-- 🔑 Login Section -->
  <div id="login-card" class="card">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button onclick="login()">Login</button>
    <p>Or <a href="#" onclick="signup()">Sign up</a></p>
  </div>

  <!-- 🏦 Contributions Section -->
  <div id="app-card" class="hidden">
    <button onclick="logout()">Logout</button>

    <div class="card">
      <h2>Add Contribution</h2>
      <input type="text" id="nameInput" placeholder="Enter name">
      <input type="number" id="amountInput" placeholder="Enter amount">
      <button onclick="addContribution()">Submit</button>
    </div>

    <div class="card">
      <h2>Search Contributions</h2>
      <input type="text" id="searchInput" placeholder="Search by name..." oninput="searchContributions()">
      <div id="searchResults"></div>
    </div>

    <div class="card">
      <h2>All Contributions</h2>
      <div id="contributionsList"></div>
      <button onclick="exportPDF()">Export PDF</button>
      <button onclick="exportExcel()">Export Excel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // 🔥 Replace with your Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginCard = document.getElementById("login-card");
    const appCard = document.getElementById("app-card");
    const contributionsList = document.getElementById("contributionsList");
    const searchResults = document.getElementById("searchResults");

    // 🔑 Auth Functions
    window.login = async function() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    };

    window.signup = async function() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Account created! Please login.");
      } catch (err) {
        alert("Signup failed: " + err.message);
      }
    };

    window.logout = async function() {
      await signOut(auth);
    };

    // 👀 Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginCard.classList.add("hidden");
        appCard.classList.remove("hidden");
      } else {
        loginCard.classList.remove("hidden");
        appCard.classList.add("hidden");
      }
    });

    // ➕ Add contribution
    window.addContribution = async function() {
      const name = document.getElementById("nameInput").value;
      const amount = document.getElementById("amountInput").value;
      if (!name || !amount) return alert("Enter name and amount");

      await addDoc(collection(db, "contributions"), {
        name,
        amount: parseFloat(amount),
        date: new Date().toISOString()
      });

      document.getElementById("nameInput").value = "";
      document.getElementById("amountInput").value = "";
    };

    // 📡 Real-time updates
    const q = query(collection(db, "contributions"), orderBy("date", "desc"));
    onSnapshot(q, (snapshot) => {
      contributionsList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        contributionsList.innerHTML += `<div class="contribution"><b>${data.name}</b> - $${data.amount}</div>`;
      });
    });

    // 🔍 Search by name
    window.searchContributions = function() {
      const term = document.getElementById("searchInput").value.toLowerCase();
      const contributions = contributionsList.querySelectorAll(".contribution");
      searchResults.innerHTML = "";
      contributions.forEach(c => {
        if (c.innerText.toLowerCase().includes(term)) {
          searchResults.appendChild(c.cloneNode(true));
        }
      });
    };

    // 📤 Export PDF
    window.exportPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Family Contributions", 20, 20);
      let y = 40;
      const contributions = contributionsList.querySelectorAll(".contribution");
      contributions.forEach(c => {
        doc.text(c.innerText, 20, y);
        y += 10;
      });
      doc.save("contributions.pdf");
    };

    // 📤 Export Excel
    window.exportExcel = function() {
      const rows = [["Name", "Amount"]];
      const contributions = contributionsList.querySelectorAll(".contribution");
      contributions.forEach(c => {
        const parts = c.innerText.split(" - $");
        rows.push([parts[0], parts[1]]);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Contributions");
      XLSX.writeFile(wb, "contributions.xlsx");
    };
  </script>
</body>
</html>
